<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üåç VPN Geo-Shifter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 60px; }
        #map { height: 400px; border-radius: 10px; margin-top: 20px; }
        .vpn-info { margin-top: 20px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center mb-4">üõ∞Ô∏è VPN Geo-Shifter</h1>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow p-4">
                <h4 class="mb-3">üîé Your Current IP Info</h4>
                <ul class="list-group mb-3">
                    <li class="list-group-item"><strong>IP:</strong> <span id="ip">{{ ip_info.ip }}</span></li>
                    <li class="list-group-item"><strong>City:</strong> <span id="city">{{ ip_info.city }}</span></li>
                    <li class="list-group-item"><strong>Country:</strong> <span id="country">{{ ip_info.country }}</span></li>
                </ul>

                {% if ip_info.error %}
                    <div class="alert alert-danger">‚ö†Ô∏è Error: {{ ip_info.error }}</div>
                {% endif %}

                <form method="post" action="/connect" class="mb-3">
                    <label class="form-label">üåê Select VPN Server:</label>
                    <div class="input-group">
                        <select class="form-select" name="vpn_config">
                            {% for name, config in vpn_configs.items() %}
                                <option value="{{ name }}" data-country-code="{{ config.country_code }}" {% if name == current_vpn %}selected{% endif %}>
                                    {{ name }}
                                </option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-primary" type="submit">Connect</button>
                    </div>
                </form>

                <form method="post" action="/disconnect">
                    <button class="btn btn-danger w-100 mb-2">Disconnect VPN</button>
                </form>

                <form>
                    <button id="ghostAutoBtn" class="btn btn-dark w-100" type="button">
                        üßô‚Äç‚ôÇÔ∏è Ghost Me & Auto-Rotate: OFF
                    </button>
                </form>

                <div class="vpn-info">
                    <h5>Recommended VPN:</h5>
                    <p><strong>{{ best_vpn['vpn_name'] }}</strong></p>
                    <p><strong>Explanation:</strong></p>
                    <p>{{ explanation|safe }}</p>
                </div>
            </div>

            <div id="map"></div>

            <!-- VPN Comparison Table -->
            <div class="vpn-info mt-4">
                <h5>VPN Comparison:</h5>
                <div>
                    {% for vpn in vpn_comparison %}
                        <p><strong>{{ vpn['vpn_name'] }}</strong> | Score: {{ vpn['score'] }} | Success Rate: {{ vpn['success_rate'] }}% | Latency: {{ vpn['latency'] }} ms | Country: {{ vpn['country_code'] }}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
    const fallbackCountryCoords = {
        "JP": [36.2048, 138.2529],
        "KR": [35.9078, 127.7669],
        "US": [37.0902, -95.7129],
        "TH": [15.8700, 100.9925],
        "UN": [0, 0]
    };

    let map = null;
    let marker = null;
    let currentIP = "{{ ip_info.ip }}";

    function getCoords(data) {
        if (data.loc && data.loc.includes(',')) {
            return data.loc.split(',').map(parseFloat);
        }
        const code = (data.country_code || data.country || "UN").toUpperCase();
        return fallbackCountryCoords[code] || [0, 0];
    }

    function updateMap(lat, lon, ip, city, country) {
        if (!map) {
            map = L.map('map').setView([lat, lon], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        if (marker) marker.remove();

        marker = L.marker([lat, lon]).addTo(map)
            .bindPopup(`<b>Current VPN</b><br>${ip}<br>${city}, ${country}`)
            .openPopup();

        map.setView([lat, lon], 4);
        document.getElementById("ip").textContent = ip;
        document.getElementById("city").textContent = city;
        document.getElementById("country").textContent = country;
    }

    function pollIPInfo() {
        fetch("/get_ip")
            .then(res => res.json())
            .then(data => {
                if (data.ip && data.ip !== currentIP) {
                    currentIP = data.ip;
                    const [lat, lon] = getCoords(data);
                    updateMap(lat, lon, data.ip, data.city, data.country);
                }
            })
            .catch(err => console.warn("IP check failed:", err));
    }

    document.addEventListener("DOMContentLoaded", function () {
        const [lat, lon] = getCoords({
            loc: "{{ ip_info.loc }}",
            country: "{{ ip_info.country }}",
            country_code: "{{ ip_info.country[:2] }}"
        });
        updateMap(lat, lon, "{{ ip_info.ip }}", "{{ ip_info.city }}", "{{ ip_info.country }}");
        setInterval(pollIPInfo, 10000); // Every 10s
    });

    let rotating = false;
    let timer = null;

    function ghostHop() {
        fetch("/ghost", { method: "POST" })
            .then(res => res.json())
            .then(() => setTimeout(pollIPInfo, 8000));
    }

    document.getElementById("ghostAutoBtn").addEventListener("click", function () {
        rotating = !rotating;
        this.innerText = rotating ? "üßô‚Äç‚ôÇÔ∏è Ghost Me & Auto-Rotate: ON" : "üßô‚Äç‚ôÇÔ∏è Ghost Me & Auto-Rotate: OFF";
        if (rotating) {
            ghostHop();
            timer = setInterval(ghostHop, 5 * 60 * 1000);
        } else {
            clearInterval(timer);
        }
    });

    document.querySelector('form[action="/connect"]').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const selectedOption = form.querySelector('option:checked');
        const expectedCountry = selectedOption.dataset.countryCode;
        const connectButton = form.querySelector('button[type="submit"]');

        connectButton.disabled = true;
        connectButton.innerHTML = 'Connecting...';

        fetch('/connect', { method: 'POST', body: formData })
            .then(() => {
                const poll = setInterval(() => {
                    fetch('/get_ip')
                        .then(res => res.json())
                        .then(ipInfo => {
                            if (ipInfo.country === expectedCountry) {
                                clearInterval(poll);
                                const [lat, lon] = getCoords(ipInfo);
                                updateMap(lat, lon, ipInfo.ip, ipInfo.city, ipInfo.country);
                            }
                        });
                }, 3000);
            })
            .finally(() => {
                connectButton.disabled = false;
                connectButton.innerHTML = 'Connect';
            });
    });
</script>
</body>
</html>
